<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weather Live View</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            height: 100vh;
            overflow: hidden;
            position: relative;
            background-color: #1a1a2e; /* Fallback background */
        }

        .video-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
            opacity: 1; /* Default opacity */
            transition: opacity 1s ease-in-out; /* Transition for fade */
        }

        .video-background .media-container {
            width: 100%;
            height: 100%;
            position: relative; /* Ensure children are positioned relative to this */
            overflow: hidden;
        }

        .video-background .media-container video,
        .video-background .media-container iframe {
            width: 100%;
            height: 100%;
            object-fit: cover; /* Ensures video/iframe covers the entire container */
            display: block; /* Remove extra space below inline elements */
            position: absolute; /* Allows object-fit to work reliably with position */
            top: 0;
            left: 0;
        }


        .gif-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2; /* Lower z-index for GIF so videos can cover it */
            background-image: url('https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExeDdra200dG45YW9qYTN5YW9qYTNyaHE0ZjNrZDR0and2OWF1NGs2ajM5enRnMiZlcD12MV9pbnRlcm5sYWZfYnlfaWQmY3Q9Zw/m2hjlbNbSRGy4/giphy.gif');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            display: none; /* Hidden by default, only shown if video fails */
        }

        /* Interstitial Image Background */
        .interstitial-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2; /* Higher than video backgrounds, lower than weather card */
            display: none; /* Hidden by default */
            opacity: 0; /* Start fully transparent */
            transition: opacity 1s ease-in-out; /* Transition for fade */
            background-color: #333; /* Fallback solid color */
        }

        .interstitial-background img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }


        /* Styles for managing active and inactive video backgrounds */
        .video-background.active-bg {
            opacity: 1;
            z-index: -1; /* Active video is above inactive */
        }

        .video-background.inactive-bg {
            opacity: 0; /* Hidden by being transparent */
            z-index: -1;
            pointer-events: none; /* Make it non-interactive when hidden */
        }


        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.1) 100%);
            z-index: 1;
        }

        .weather-container {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            padding: 20px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        .weather-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            /* Added flex properties to center content reliably within the card */
            display: flex;
            flex-direction: column;
            align-items: center; /* This will center all direct children horizontally */
            
            text-align: center; /* Keep for general text alignment for non-flex children or inline content */
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            max-width: 500px;
            width: 100%;
            animation: fadeInUp 1s ease-out; /* Keep initial fade-in */
            opacity: 1; /* Default to visible */
            transition: opacity 1s ease-in-out, transform 1s ease-in-out; /* Combined for fade and slide */
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .location {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: white;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.9);
            font-family: 'Arial Black', Arial, sans-serif;
            letter-spacing: 1px;
        }

        .current-temp {
            font-size: 6rem;
            font-weight: 100;
            margin: 10px 0; /* Tightened spacing */
            line-height: 1;
        }

        .current-date {
            font-size: 1.3rem; /* Slightly smaller than time */
            margin-bottom: 5px;
            opacity: 0.8;
            font-weight: 400;
        }

        .current-time {
            font-size: 1.9rem; /* Slightly larger for emphasis */
            margin-bottom: 10px; /* Space before temperature */
            opacity: 0.95;
            font-weight: 600;
        }

        .weather-description {
            font-size: 1.8rem;
            margin-bottom: 15px; /* Tightened spacing */
            opacity: 0.9;
            text-transform: capitalize;
            font-weight: 500;
        }

        .weather-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 15px; /* Tightened spacing */
            padding: 20px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            /* Ensure grid itself is centered within its flex parent (.weather-card) */
            justify-content: center; /* For grid, similar to align-items: center for flex column */
            align-items: center; /* For grid, if items themselves need vertical alignment */
            width: 100%; /* Important for centering if content is smaller than card */
        }

        .detail-item {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0.08) 100%);
            padding: 20px 15px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .detail-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .detail-item:hover {
            transform: translateY(-5px) scale(1.02);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.18) 0%, rgba(255, 255, 255, 0.12) 100%);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .detail-item:hover::before {
            transform: scaleX(1);
        }

        .detail-item:nth-child(1)::before {
            background: linear-gradient(90deg, #ff9a9e 0%, #fecfef 100%);
        }

        .detail-item:nth-child(2)::before {
            background: linear-gradient(90deg, #a8edea 0%, #fed6e3 100%);
        }

        .detail-item:nth-child(3)::before {
            background: linear-gradient(90deg, #ffecd2 0%, #fcb69f 100%);
        }

        .detail-item:nth-child(4)::before {
            background: linear-gradient(90deg, #a8c8ec 0%, #7faadb 100%);
        }

        .detail-label {
            font-size: 1rem;
            opacity: 0.85;
            margin-bottom: 8px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: rgba(255, 255, 255, 0.9);
        }

        .detail-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: white;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
        }

        /* News Ticker Styles */
        .news-ticker {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 80px;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.9) 0%, rgba(20, 20, 20, 0.95) 100%);
            backdrop-filter: blur(15px);
            border-top: 2px solid rgba(255, 255, 255, 0.1);
            z-index: 10;
            overflow: hidden;
            display: flex;
            align-items: center;
        }

        .news-label {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
            padding: 0 20px;
            height: 100%;
            display: flex;
            align-items: center;
            font-weight: bold;
            font-size: 1.8rem; /* Increased font size for NEWS label */
            text-transform: uppercase;
            letter-spacing: 1px;
            min-width: 140px;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3);
        }

        .news-content {
            flex: 1;
            height: 100%;
            overflow: hidden; /* This hides the overflowing content, crucial for marquee effect */
            position: relative;
        }

        .news-scroll {
            display: flex; /* Makes sure the inner duplicated content sits side-by-side */
            width: max-content; /* Allows this container to be as wide as all its content */
            height: 100%;
            align-items: center;
            animation: scroll-left 90s linear infinite; /* Animation applied here */
        }

        /* Target the duplicated news content blocks inside news-scroll */
        .news-scroll > div {
            white-space: nowrap; /* Ensures all news items within each block stay on one line */
            display: inline-flex; /* Ensures proper layout of news items */
            align-items: center;
        }

        @keyframes scroll-left {
            0% {
                transform: translateX(0);
            }
            /* Move exactly one copy of the content to the left for a seamless loop */
            100% {
                transform: translateX(-50%); /* Moves 50% of news-scroll's total width (one full content block) */
            }
        }

        .news-item {
            color: white;
            font-size: 1.8rem;
            margin-right: 80px;
            display: inline-flex;
            align-items: center;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
            font-weight: 500;
        }

        .news-item::before {
            content: "●";
            color: #ff6b6b;
            margin-right: 16px;
            font-size: 1.4rem;
        }

        .news-loading {
            color: white;
            font-size: 1.6rem;
            padding: 0 20px;
            opacity: 0.7;
            font-weight: 500;
        }

        .loading {
            font-size: 1.5rem;
            opacity: 0.8;
        }

        .error {
            color: #ff6b6b;
            font-size: 1.2rem;
            text-align: center;
        }

        @media (max-width: 768px) {
            .weather-card {
                padding: 30px 20px;
                margin: 20px;
            }
            .location {
                font-size: 2.5rem;
            }
            .current-temp {
                font-size: 5rem;
            }
            .current-date {
                font-size: 1.1rem;
            }
            .current-time {
                font-size: 1.6rem;
            }
            .weather-description {
                font-size: 1.6rem;
            }
            .weather-details {
                grid-template-columns: 1fr;
                gap: 12px;
                padding: 15px;
            }
            .detail-item {
                padding: 15px 12px;
            }
            .detail-label {
                font-size: 0.9rem;
            }
            .detail-value {
                font-size: 1.6rem;
            }
            /* News Ticker Media Queries */
            .news-ticker {
                height: 70px;
            }

            .news-item {
                font-size: 1.5rem;
                margin-right: 60px;
            }

            .news-label {
                font-size: 1.5rem; /* Adjusted for mobile */
                min-width: 120px;
            }
        }
    </style>
</head>
<body>
    <div class="video-background active-bg" id="videoBackground1">
        <div class="media-container" id="mediaContainer1">
            </div>
    </div>
    <div class="video-background inactive-bg" id="videoBackground2">
        <div class="media-container" id="mediaContainer2">
            </div>
    </div>

    <div class="interstitial-background" id="interstitialBackground">
        <img id="interstitialImage" src="https://images.pexels.com/photos/1118873/pexels-photo-1118873.jpeg?cs=srgb&dl=pexels-jplenio-1118873.jpg&fm=jpg" alt="Transition Image - Weather and Landscape" onerror="this.onerror=null; this.src='https://placehold.co/1920x1080/000000/FFFFFF?text=Image+Unavailable';" >
    </div>

    <div class="gif-background" id="gifBackground"></div>
    <div class="overlay"></div>

    <div class="weather-container">
        <div class="weather-card" id="weatherCard">
            <div class="loading" id="loading">Loading weather data...</div>
        </div>
    </div>

    <div class="news-ticker">
        <div class="news-label">NEWS</div>
        <div class="news-content">
            <div class="news-scroll" id="newsScroll">
                <div class="news-loading">Loading latest news...</div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.4.10/hls.min.js"></script>
    <script>
        // API key for OpenWeatherMap (replace with your own if you have one)
        const API_KEY = '1cf8937cc9682ba717da9c52c975283e';
        
        // Define the city configurations
        const CITIES = [
            {
                displayName: 'Syracuse',
                apiName: 'Syracuse',
                state: 'NY', 
                countryCode: 'US', 
                stream: 'https://tower.armorycam.com/stream/armorystream.m3u8',
                fallbackImageUrl: 'https://www.syracuse.com/resizer/XEzJNnUyf1v3P8uP0NtUDhnCd-o=/arc-anglerfish-arc2-prod-advancelocal/public/ASOGP6SJG5AAVPB5KEFSAJHNT4.jpg' 
            },
            {
                displayName: 'Vancouver',
                apiName: 'Vancouver',
                state: 'BC', 
                countryCode: 'CA', 
                stream: 'https://www.youtube.com/embed/sLixr8cThJo', // Updated YouTube embed URL
                fallbackImageUrl: 'https://cleanenergycanada.org/wp-content/uploads/2021/12/shutterstock_1531447955-scaled.jpg' 
            },
            {
                displayName: 'Myrtle Beach', 
                apiName: 'Myrtle Beach',     
                state: 'SC',
                countryCode: 'US',
                stream: 'https://www.youtube.com/embed/MAPDh0XDtZs',
                fallbackImageUrl: 'https://www.myrtlebeach.com/wp-content/uploads/2016/11/Homepage-Main.jpg' 
            },
            {
                displayName: 'Toronto',
                apiName: 'Toronto',
                state: 'ON', 
                countryCode: 'CA', 
                stream: 'https://www.youtube.com/embed/-Js36EsiUgA',
                fallbackImageUrl: 'https://www.nomadicmatt.com/wp-content/uploads/2018/01/torontoguide.jpg' 
            },
            {
                displayName: 'Grand Forks',
                apiName: 'Grand Forks',
                state: 'ND',
                countryCode: 'US',
                stream: 'https://www.youtube.com/embed/mpcvRHLGBRw',
                fallbackImageUrl: 'https://media.discordapp.net/attachments/1275781545675722845/1384537200468819978/unnamed-e1623966048345-jpg.png?ex=68629c40&is=68614ac0&hm=8d6ce680c571b2cfb21eb59f75dc1221733003e63c51aaaf73ff4c4d3526c9d4&=&format=webp&quality=lossless' 
            },
            {
                displayName: 'City of Seaside', 
                apiName: 'Seaside', 
                state: 'OR',
                countryCode: 'US',
                stream: 'https://www.youtube.com/embed/JjI5KtjJGfo', 
                fallbackImageUrl: 'https://www.visitoregon.com/wp-content/uploads/2022/02/junctioncave-1024x768.jpg'
            }
        ];

        let currentCityIndex = 0;
        let activeVideoBackgroundId = 'videoBackground1'; 

        // RSS2JSON API Key 
        const RSS_API_KEY = 'ngd011e5pl0bwl0ejgfc0eu7126l19yaenu4iewv'; 
        
        // RSS Feed Sources (from USA News Firehose.xml, excluding the problematic Reuters feed)
        const RSS_SOURCES = [
            "http://feeds.foxnews.com/foxnews/national",
            "http://rss.cnn.com/rss/edition_us.rss"
        ];

        const FALLBACK_GIF = 'https://media0.giphy.com/media/v1.Y2lkPTc5MGI3NjExeDdra200dG45YW9qYTN5YW9qYTNyaHE0ZjNrZDR0and2OWF1NGs2ajM5enRnMiZlcD12MV9pbnRlcm5sYWZfYnlfaWQmY3Q9Zw/m2hjlbNbSRGy4/giphy.gif';
        
        // Initialize weatherData with a default timezone to prevent errors before first fetch
        let weatherData = { timezone: 0 }; 
        let newsData = [];
        let videoLoadTimeout;
        let hlsInstance = null; 
        let preLoadTimeoutId = null; 
        let cityRotationInterval; // Variable to hold the interval ID

        // Function to show GIF fallback, adapting for two video backgrounds
        function showGifFallback() {
            document.getElementById('videoBackground1').style.display = 'none';
            document.getElementById('videoBackground2').style.display = 'none';
            document.getElementById('interstitialBackground').style.display = 'none'; 
            document.getElementById('gifBackground').style.display = 'block';
            console.log('Showing GIF fallback for ALL video backgrounds due to stream error.');
        }

        // Function to hide GIF fallback and show the active video background
        function hideGifFallback() {
            document.getElementById('gifBackground').style.display = 'none';
            document.getElementById(activeVideoBackgroundId).style.display = 'block';
            console.log(`Hiding GIF fallback, showing active video: ${activeVideoBackgroundId}`);
        }

        // Initialize video stream (or embed) for a specific video background div
        function loadVideo(videoBackgroundDiv, streamUrl) {
            return new Promise((resolve) => {
                clearTimeout(videoLoadTimeout); 
                const mediaContainer = videoBackgroundDiv.querySelector('.media-container');
                mediaContainer.innerHTML = ''; 

                let currentVideoLoadTimeout = setTimeout(() => {
                    console.log(`Media load timeout for ${streamUrl}. Initiating GIF fallback.`);
                    showGifFallback();
                    resolve(false); 
                }, 7000); // 7-second timeout for video load

                if (streamUrl.includes('youtube.com/embed/')) {
                    // YouTube Embed
                    const iframe = document.createElement('iframe');
                    const videoId = streamUrl.split('/').pop().split('?')[0]; 
                    iframe.src = `${streamUrl}?autoplay=1&mute=1&controls=0&loop=1&playlist=${videoId}`;
                    iframe.title = 'Live Stream';
                    iframe.frameborder = '0';
                    iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
                    iframe.referrerPolicy = 'strict-origin-when-cross-origin';
                    iframe.allowFullscreen = true;
                    iframe.style.width = '100%';
                    iframe.style.height = '100%';
                    iframe.style.objectFit = 'cover'; 
                    iframe.style.position = 'absolute'; 
                    iframe.style.top = '0';
                    iframe.style.left = '0';

                    iframe.onload = () => {
                        console.log(`YouTube iframe loaded for: ${streamUrl}`);
                        clearTimeout(currentVideoLoadTimeout);
                        hideGifFallback(); // Hide GIF if it was shown
                        resolve(true);
                    };
                    iframe.onerror = () => {
                        console.error(`YouTube iframe failed to load for: ${streamUrl}`);
                        clearTimeout(currentVideoLoadTimeout);
                        showGifFallback();
                        resolve(false);
                    };
                    mediaContainer.appendChild(iframe);

                } else if (streamUrl.endsWith('.m3u8')) {
                    // HLS Stream
                    const videoElement = document.createElement('video');
                    videoElement.autoplay = true;
                    videoElement.muted = true;
                    videoElement.loop = true;
                    videoElement.playsInline = true;
                    videoElement.style.width = '100%';
                    videoElement.style.height = '100%';
                    videoElement.style.objectFit = 'cover';

                    mediaContainer.appendChild(videoElement);

                    // If an Hls instance exists and is attached to the *other* video element, destroy it
                    // Or if current hlsInstance is still playing in the target video element, destroy it for a clean reload
                    if (hlsInstance && hlsInstance.media && hlsInstance.media !== videoElement) {
                        hlsInstance.destroy();
                        hlsInstance = null;
                    } else if (hlsInstance && hlsInstance.media === videoElement) {
                        // If it's the same video element, destroy and re-create for a fresh load
                        hlsInstance.destroy();
                        hlsInstance = null;
                    }
                    
                    if (Hls.isSupported()) {
                        hlsInstance = new Hls({ enableWorker: true, lowLatencyMode: true, backBufferLength: 90 });
                        hlsInstance.loadSource(streamUrl);
                        hlsInstance.attachMedia(videoElement);
                        hlsInstance.on(Hls.Events.MANIFEST_PARSED, function onManifestParsed() {
                            console.log(`HLS manifest parsed for stream: ${streamUrl}`);
                            videoElement.play().then(() => {
                                clearTimeout(currentVideoLoadTimeout); 
                                hideGifFallback(); 
                                resolve(true); 
                            }).catch(e => {
                                console.error(`Video play failed for ${streamUrl} (browser autoplay policy):`, e);
                                clearTimeout(currentVideoLoadTimeout); 
                                showGifFallback(); 
                                resolve(false);
                            });
                            hlsInstance.off(Hls.Events.MANIFEST_PARSED, onManifestParsed); 
                        });
                        hlsInstance.on(Hls.Events.ERROR, function onHlsError(event, data) {
                            console.error(`Hls.js fatal error for ${streamUrl}:`, data.type, data.details);
                            if (data.fatal) {
                                clearTimeout(currentVideoLoadTimeout); 
                                showGifFallback(); 
                                if (hlsInstance) {
                                    hlsInstance.destroy(); // Ensure Hls instance is destroyed on fatal error
                                    hlsInstance = null;
                                }
                                hlsInstance.off(Hls.Events.ERROR, onHlsError); 
                                resolve(false); 
                            }
                        });
                    } else if (videoElement.canPlayType('application/vnd.apple.mpegurl')) {
                        // Native HLS for Safari
                        videoElement.src = streamUrl;
                        videoElement.addEventListener('loadedmetadata', function onLoadedMetadata() {
                            videoElement.play().then(() => {
                                clearTimeout(currentVideoLoadTimeout);
                                hideGifFallback();
                                resolve(true);
                            }).catch(e => {
                                console.error(`Video play failed (native) for ${streamUrl}:`, e);
                                clearTimeout(currentVideoLoadTimeout);
                                showGifFallback();
                                resolve(false);
                            });
                            videoElement.removeEventListener('loadedmetadata', onLoadedMetadata);
                        });
                        videoElement.addEventListener('error', function onVideoError() {
                            console.error(`Native video playback error for ${streamUrl}.`);
                            clearTimeout(currentVideoLoadTimeout);
                            showGifFallback(); 
                            videoElement.removeEventListener('error', onVideoError);
                            resolve(false);
                        });
                    } else {
                        console.error('HLS is not supported by Hls.js or natively for stream:', streamUrl);
                        clearTimeout(currentVideoLoadTimeout);
                        showGifFallback();
                        resolve(false); 
                    }
                } else if (streamUrl.endsWith('.mjpg')) {
                    // MJPEG Stream - load directly via <video> tag
                    const videoElement = document.createElement('video');
                    videoElement.autoplay = true;
                    videoElement.muted = true;
                    videoElement.loop = true;
                    videoElement.playsInline = true;
                    videoElement.src = streamUrl;
                    videoElement.style.width = '100%';
                    videoElement.style.height = '100%';
                    videoElement.style.objectFit = 'cover';

                    mediaContainer.appendChild(videoElement);

                    videoElement.addEventListener('loadeddata', function onLoadedData() {
                        console.log(`MJPEG stream loadeddata for: ${streamUrl}`);
                        videoElement.play().then(() => {
                            clearTimeout(currentVideoLoadTimeout);
                            hideGifFallback();
                            resolve(true);
                        }).catch(e => {
                            console.error(`MJPEG video play failed for ${streamUrl}:`, e);
                            clearTimeout(currentVideoLoadTimeout);
                            showGifFallback();
                            resolve(false);
                        });
                        videoElement.removeEventListener('loadeddata', onLoadedData);
                    });
                    videoElement.addEventListener('error', function onVideoError() {
                        console.error(`MJPEG video playback error for ${streamUrl}.`);
                        clearTimeout(currentVideoLoadTimeout);
                        showGifFallback();
                        videoElement.removeEventListener('error', onVideoError);
                        resolve(false);
                    });
                } else {
                    console.error('Unsupported video stream format or embed type:', streamUrl);
                    clearTimeout(currentVideoLoadTimeout);
                    showGifFallback();
                    resolve(false);
                }
            });
        }

        // Fetch weather data from OpenWeatherMap
        async function fetchWeatherDataAsync(apiCityName, state, countryCode) { 
            console.log(`Fetching weather data for ${apiCityName}, ${state ? state + ', ' : ''}${countryCode}...`);
            let queryParam = `${apiCityName}`;
            // OpenWeatherMap usually works better with just city,countryCode for non-US
            // For US, state code can help disambiguate
            if (countryCode === 'US' && state) { 
                queryParam += `,${state},${countryCode}`;
            } else if (countryCode) {
                queryParam += `,${countryCode}`;
            }

            const url = `https://api.openweathermap.org/data/2.5/weather?q=${queryParam}&units=imperial&appid=${API_KEY}`;

            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`Weather data not found for ${apiCityName}, ${state}. Status: ${response.status}`);
                }
                weatherData = await response.json(); 
                // Store the main weather condition (no longer used for Unsplash query directly)
                weatherData.fetchedCondition = weatherData.weather[0]?.main || weatherData.weather[0]?.description || 'weather';
                console.log('Weather data fetched:', weatherData);
                return weatherData; 
            } catch (error) {
                console.error('Error fetching weather data:', error.message);
                return null; 
            }
        }

        // Display weather data
        function displayWeatherData(data, cityDisplayName, state) {
            const weatherCard = document.getElementById('weatherCard');
            // Check if state is relevant for display, e.g., only for US cities or if the state is truly significant
            const displayLocation = state && CITIES[currentCityIndex].countryCode === 'US' ? `${cityDisplayName}, ${state}` : cityDisplayName;

            if (!data || !data.main || !data.weather || !data.wind) {
                weatherCard.innerHTML = `
                    <div class="location">${displayLocation}</div>
                    <div class="error" style="margin-top: 20px;">Weather data currently unavailable.</div>
                    <div class="current-date" id="currentDate"></div>
                    <div class="current-time" id="currentTime"></div>
                `;
                updateClock(); // Update clock even on error to show browser time
                return; 
            }

            // Update global weatherData object (including timezone)
            weatherData = data; 

            const temp = Math.round(data.main.temp);
            const feelsLike = Math.round(data.main.feels_like);
            const description = data.weather[0]?.description || 'N/A'; 
            const humidity = data.main.humidity || 'N/A';
            const windSpeed = Math.round(data.wind.speed) || 'N/A';
            const windDirection = data.wind.deg ? getWindDirection(data.wind.deg) : 'N/A';
            const visibility = data.visibility ? (data.visibility / 1609.34).toFixed(1) : 'N/A'; // Convert meters to miles

            weatherCard.innerHTML = `
                <div class="location">${displayLocation}</div>
                <div class="current-date" id="currentDate"></div>
                <div class="current-time" id="currentTime"></div>
                <div class="current-temp">${temp}°F</div>
                <div class="weather-description">${description}</div>
                <div class="weather-details">
                    <div class="detail-item">
                        <div class="detail-label">Feels Like</div>
                        <div class="detail-value">${feelsLike}°F</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Humidity</div>
                        <div class="detail-value">${humidity}%</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Wind</div>
                        <div class="detail-value">${windSpeed} mph ${windDirection}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Visibility</div>
                        <div class="detail-value">${visibility} mi</div>
                    </div>
                </div>
            `;
            updateClock(); 
        }

        // Helper function to get wind direction from degrees
        function getWindDirection(deg) {
            const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
            const index = Math.round((deg % 360) / 45);
            return directions[index % 8];
        }

        // Update current time and date based on city's timezone
        function updateClock() {
            const currentDateElement = document.getElementById('currentDate');
            const currentTimeElement = document.getElementById('currentTime');

            // Only proceed if elements exist and weatherData has a valid timezone
            if (!currentDateElement || !currentTimeElement || weatherData.timezone === undefined || weatherData.timezone === null) {
                // Fallback to local browser time if city timezone is not available
                const now = new Date();
                currentDateElement.textContent = now.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                currentTimeElement.textContent = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
                return;
            }

            const now = new Date(); // Current time in local browser timezone
            const utcTime = now.getTime() + (now.getTimezoneOffset() * 60 * 1000); // Convert to UTC milliseconds
            const cityLocalTimeMs = utcTime + (weatherData.timezone * 1000); // Apply city's UTC offset

            const cityDate = new Date(cityLocalTimeMs);

            // Date format: Weekday, Month Day, Year
            const optionsDate = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const formattedDate = cityDate.toLocaleDateString('en-US', optionsDate);
            currentDateElement.textContent = formattedDate;

            // Time format: hour:minute only, AM/PM
            const optionsTime = { hour: '2-digit', minute: '2-digit', hour12: true };
            const formattedTime = cityDate.toLocaleTimeString('en-US', optionsTime);
            currentTimeElement.textContent = formattedTime;
        }

        // Call updateClock every second
        setInterval(updateClock, 1000);

        // Fetch news data from RSS sources using rss2json.com proxy
        async function fetchNewsData() {
            console.log("Attempting to fetch news from RSS feeds via rss2json.com proxy...");
            let allArticles = [];

            for (const rssUrl of RSS_SOURCES) {
                // Construct the RSS2JSON API URL with your provided RSS2JSON API key
                // and the current RSS feed URL.
                const fullProxyUrl = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(rssUrl)}&api_key=${RSS_API_KEY}`;
                try {
                    const response = await fetch(fullProxyUrl);
                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`Failed to fetch RSS from ${rssUrl} via proxy: ${response.status} ${response.statusText} - ${errorText}`);
                    }
                    const data = await response.json();
                    
                    // Check if the API returned an error, specifically for rss2json.com errors
                    if (data.status === 'error') {
                        throw new Error(`RSS2JSON API error for ${rssUrl}: ${data.message}`);
                    }

                    if (data && data.items) {
                        const sourceArticles = data.items
                            .filter(item => item.title && item.description)
                            .map(item => ({
                                title: item.title.replace(/<[^>]*>?/gm, ''), // Remove HTML tags from title
                                description: item.description.replace(/<[^>]*>?/gm, '') // Remove HTML tags from description
                            }));
                        allArticles = allArticles.concat(sourceArticles);
                        console.log(`Fetched ${sourceArticles.length} articles from ${rssUrl} via proxy`);
                    } else {
                        console.warn(`No items found or unexpected response format in RSS feed: ${rssUrl} via proxy`);
                    }
                } catch (error) {
                    console.error(`Error fetching RSS feed ${rssUrl} via proxy:`, error);
                }
            }

            if (allArticles.length > 0) {
                newsData = allArticles;
                console.log('Combined news data fetched:', newsData);
            } else {
                // Fallback message if no articles were successfully loaded from any source
                newsData = [{ title: 'News feed unavailable. Please check RSS2JSON API key or the RSS feed URLs.', description: '' }];
                console.warn('No news articles loaded. Displaying fallback message.');
            }
            displayNewsTicker();
        }

        // Display news in the ticker
        function displayNewsTicker() {
            const newsScroll = document.getElementById('newsScroll');
            if (!newsScroll) return;

            newsScroll.innerHTML = ''; // Clear existing content

            if (newsData.length === 0) {
                newsScroll.innerHTML = '<div class="news-loading">No news to display.</div>';
                return;
            }

            // Create a single block of news items
            const newsItemsHtml = newsData.map(item => `<div class="news-item">${item.title}</div>`).join('');
            
            // Duplicate the content to ensure seamless looping
            newsScroll.innerHTML = `<div>${newsItemsHtml}</div><div>${newsItemsHtml}</div>`;

            // Adjust animation duration based on content length for smoother scroll
            const contentWidth = newsScroll.scrollWidth / 2; // Width of one set of duplicated content
            const tickerSpeed = 60; // Pixels per second
            const duration = contentWidth / tickerSpeed; // Seconds
            newsScroll.style.animationDuration = `${duration}s`;
        }

        // Function to load image and ensure it's fully loaded
        function loadImage(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.src = url;
                img.onload = () => resolve(img);
                img.onerror = (e) => {
                    console.error(`Failed to load image: ${url}`, e);
                    reject(new Error(`Image load error for ${url}`));
                };
            });
        }

        // Function to smoothly transition backgrounds
        async function transitionBackground(newVideoDivId, newStreamUrl) {
            const activeBg = document.getElementById(activeVideoBackgroundId);
            const nextBg = document.getElementById(newVideoDivId);
            const interstitialBg = document.getElementById('interstitialBackground');
            const interstitialImage = document.getElementById('interstitialImage');

            // Get the current city object to check for specific fallback image
            const currentCity = CITIES[currentCityIndex];

            let imageUrl = currentCity.fallbackImageUrl; 

            // Try to load the image first
            try {
                const loadedImage = await loadImage(imageUrl);
                interstitialImage.src = loadedImage.src; // Set src only after it's loaded
            } catch (error) {
                console.warn(`Could not load specific fallback image for ${currentCity.displayName}. Falling back to generic.`);
                interstitialImage.src = 'https://placehold.co/1920x1080/000000/FFFFFF?text=Image+Unavailable';
            }
            
            // Step 1: Show interstitial by setting display to block and fading in its opacity
            interstitialBg.style.display = 'block';
            interstitialBg.style.opacity = '1';
            await new Promise(resolve => setTimeout(resolve, 1000)); // Wait for interstitial fade-in

            // Step 2: Load the next video into the 'nextBg' container
            console.log(`Preloading video for ${newStreamUrl} into ${newVideoDivId}`);
            await loadVideo(nextBg, newStreamUrl);

            // Step 3: Fade out the current active video and fade in the new one
            activeBg.classList.remove('active-bg');
            activeBg.classList.add('inactive-bg');
            
            nextBg.classList.remove('inactive-bg');
            nextBg.classList.add('active-bg');

            // Update the active background ID
            activeVideoBackgroundId = newVideoDivId; 

            // Step 4: Wait for the video transitions to complete
            await new Promise(resolve => setTimeout(resolve, 1000)); // Match video transition duration

            // Step 5: Fade out the interstitial and hide it
            interstitialBg.style.opacity = '0';
            await new Promise(resolve => setTimeout(resolve, 1000)); // Wait for interstitial fade-out
            interstitialBg.style.display = 'none'; // Finally hide it from layout
        }


        // Main function to update weather, video, and rotate cities
        async function updateCityView() {
            const city = CITIES[currentCityIndex];
            const nextCityIndex = (currentCityIndex + 1) % CITIES.length;
            const nextCity = CITIES[nextCityIndex];

            // Determine which video background will become active and which will be preloaded
            const currentVideoBgDiv = document.getElementById(activeVideoBackgroundId);
            const nextVideoBgId = activeVideoBackgroundId === 'videoBackground1' ? 'videoBackground2' : 'videoBackground1';
            const nextVideoBgDiv = document.getElementById(nextVideoBgId);

            console.log(`Switching to city: ${city.displayName}`);

            // Fetch weather data for the current city
            const weather = await fetchWeatherDataAsync(city.apiName, city.state, city.countryCode);
            displayWeatherData(weather, city.displayName, city.state);

            // Perform background transition with the current city's stream
            await transitionBackground(currentVideoBgDiv.id, city.stream);
            
            // Set up preloading for the *next* city's video
            clearTimeout(preLoadTimeoutId); // Clear any existing preload timeout
            preLoadTimeoutId = setTimeout(async () => {
                console.log(`Preloading next city video (${nextCity.displayName}) into ${nextVideoBgId}`);
                await loadVideo(nextVideoBgDiv, nextCity.stream);
            }, 1000); // Start preloading after the current video has loaded for 1 second

            // Advance to the next city for the next cycle
            currentCityIndex = nextCityIndex;
        }

        // Initial load and then set interval for rotation
        document.addEventListener('DOMContentLoaded', async () => {
            // Initial fetch for the first city
            await updateCityView(); 
            fetchNewsData(); // Fetch news once on load

            // Set interval for city rotation every 60 seconds (60000 milliseconds)
            cityRotationInterval = setInterval(updateCityView, 60000); // 1 minute

            // Set interval for news update every 30 minutes (1800000 milliseconds)
            setInterval(fetchNewsData, 1800000); 
        });

    </script>
</body>
</html>
